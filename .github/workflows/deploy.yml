name: Laravel Deployment

on:
  push:
    branches:
      - uat # Trigger deployment for UAT branch
      - main # Trigger deployment for Production branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        environment: [uat, production] # Define environments
        host: [uat.moneytreerealty.in, moneytreerealty.in]
        user: [UAT_USER, PRODUCTION_USER]
        path: [UAT_PATH, PRODUCTION_PATH]

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up PHP environment
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, exif, pcntl, bcmath, intl, pdo, mysqli
          ini-values: post_max_size=256M, upload_max_filesize=256M

      # Step 3: Install Composer dependencies
      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      # Step 4: Set permissions for storage and cache
      - name: Set permissions for storage and cache
        run: |
          chmod -R 777 storage bootstrap/cache

      # Step 5: Deploy to the appropriate environment
      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets[matrix.host] }}
          USER: ${{ secrets[matrix.user] }}
          DEPLOY_PATH: ${{ secrets[matrix.path] }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan $HOST >> ~/.ssh/known_hosts
          ssh $USER@$HOST "
            cd $DEPLOY_PATH &&
            git pull origin ${{ matrix.environment }} &&
            composer install --no-dev --prefer-dist --optimize-autoloader &&
            php artisan migrate --force &&
            php artisan cache:clear &&
            php artisan config:clear &&
            php artisan route:cache &&
            php artisan view:cache &&
            chmod -R 777 storage bootstrap/cache
          "
